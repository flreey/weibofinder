<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" charset="utf-8"/>
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #map_canvas { height: 100% }
</style>
<script type="text/javascript"
    src="https://maps.google.com/maps/api/js?&zoom=12&sensor=false">
</script>
<script type="text/javascript" 
    src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js">
</script>
<script type="text/javascript">
    /*
  function initialize(lat, lng) {
    window.mark_infos = []
    var myLatlng = new google.maps.LatLng(lng, lat);
    var myOptions = {
      zoom: 10,
      center: myLatlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);


    var show_map = function(msg) {
        var showImage = "<img src='/static/adaptable.png'/>" + "<br/><br/><center>这里再添加微博内容！</center>";

      info = new google.maps.InfoWindow({
        content: showImage
        });
      window.mark_infos.push(info)

      var myLatlng = new google.maps.LatLng(msg.lat, msg.lng);
      var maker = new google.maps.Marker({
        position: myLatlng,
        map: map,
        title:"有新发现:-)",
        icon: msg.photo
      });

      google.maps.event.addListener(maker, 'click', function() {
        for (var i = 0; i < window.mark_infos.length; ++i) {
            window.mark_infos.close();
        }
        info.open(map, maker);
      });

    }

    $.get('/asyn/'+lng+'/'+lat,
        function(data) {
            if (data.success) {
                for (var i = 0; i < data.msgs.length; ++i) {
                    show_map(data.msgs[i]);
                }
            }
        }
    )

    $.get('/update', function(data) {
        if (data.success) {
            alert(data.msg);
        }
    })
  }
  */
var map;
var marker;
var infowindow;   //Global infowindow created
function initialize(lat, lng) {
  var latlng = new google.maps.LatLng(lng, lat);
  var restaurants = new Array();
  restaurants = [ 
         new google.maps.LatLng(lng, lat),
         ];
   var myOptions = {
      zoom: 3,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map_canvas"),
        myOptions);

    var asyn = function() {
      $.get('/asyn/'+lng+'/'+lat,
            function(data) {
                if (data.success) {
                    var msgs = data.msgs;
                    var i = 0; 
                    for ( i <0; i < msgs.length;i++ ){          
                        var showImage = "<img src='"+msgs[i].photo+"'/>" + "<br/><br/><center>这里再添加微博内容！</center>";
                        infowindow = new google.maps.InfoWindow({   //infowindow options set
                               content: showImage,
                               size: new google.maps.Size(50, 20)
        });


                         var photo = new google.maps.LatLng(msgs[i].lng, msgs[i].lat);
                          marker = new google.maps.Marker({
                                      position: photo,
                                      map:map,
                                      title:"Testing!",
                               });
                           popupDirections(marker);
                    }

                }
            }
        )
      }

    var update = function() {
        $.get('/update',
                function(data) {
                 //   setTimeout("update()", 1000);
                }
            );
    }

    function timeout() {
        asyn();
        //update();
    }
    setInterval(timeout, 2000);
}

function popupDirections(marker) {
  //this function created listener listens for click on a marker
  google.maps.event.addListener(marker, 'click', function() {
    infowindow.open(map,marker); //then opens the infowindow at the marker
  });
}


</script>
</head>
<body onload="initialize({{lat}}, {{lng}})">
  <div id="map_canvas" style="width:100%; height:100%"></div>
</body>
</html>
